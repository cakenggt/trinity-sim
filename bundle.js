(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
exports.data = {
  "2016": {
    "sp500":1918.6,
    "cpi":236.92,
    "dividend":0.0223,
    "treasuryrate":0.0209
  },
  "2015": {
    "sp500":2028.18,
    "cpi":233.71,
    "dividend":0.0211,
    "treasuryrate":0.0188
  },
  "2014": {
    "sp500":1822.36,
    "cpi":233.92,
    "dividend":0.0192,
    "treasuryrate":0.0286
  },
  "2013": {
    "sp500":1480.4,
    "cpi":230.28,
    "dividend":0.0194,
    "treasuryrate":0.0191
  },
  "2012": {
    "sp500":1300.58,
    "cpi":226.67,
    "dividend":0.022,
    "treasuryrate":0.0197
  },
  "2011": {
    "sp500":1282.62,
    "cpi":220.22,
    "dividend":0.0213,
    "treasuryrate":0.0339
  },
  "2010": {
    "sp500":1123.58,
    "cpi":216.69,
    "dividend":0.0183,
    "treasuryrate":0.0373
  },
  "2009": {
    "sp500":865.58,
    "cpi":211.14,
    "dividend":0.0202,
    "treasuryrate":0.0252
  },
  "2008": {
    "sp500":1378.76,
    "cpi":211.08,
    "dividend":0.0323,
    "treasuryrate":0.0374
  },
  "2007": {
    "sp500":1424.16,
    "cpi":202.42,
    "dividend":0.0187,
    "treasuryrate":0.0476
  },
  "2006": {
    "sp500":1278.73,
    "cpi":198.3,
    "dividend":0.0176,
    "treasuryrate":0.0442
  },
  "2005": {
    "sp500":1181.41,
    "cpi":190.7,
    "dividend":0.0176,
    "treasuryrate":0.0422
  },
  "2004": {
    "sp500":1132.52,
    "cpi":185.2,
    "dividend":0.0162,
    "treasuryrate":0.0415
  },
  "2003": {
    "sp500":895.84,
    "cpi":181.7,
    "dividend":0.0161,
    "treasuryrate":0.0405
  },
  "2002": {
    "sp500":1140.21,
    "cpi":177.1,
    "dividend":0.0179,
    "treasuryrate":0.0504
  },
  "2001": {
    "sp500":1335.63,
    "cpi":175.1,
    "dividend":0.0137,
    "treasuryrate":0.0516
  },
  "2000": {
    "sp500":1425.59,
    "cpi":168.8,
    "dividend":0.0122,
    "treasuryrate":0.0666
  },
  "1999": {
    "sp500":1248.77,
    "cpi":164.3,
    "dividend":0.0117,
    "treasuryrate":0.0472
  },
  "1998": {
    "sp500":963.36,
    "cpi":161.6,
    "dividend":0.0136,
    "treasuryrate":0.0554
  },
  "1997": {
    "sp500":766.22,
    "cpi":159.1,
    "dividend":0.0161,
    "treasuryrate":0.0658
  },
  "1996": {
    "sp500":614.42,
    "cpi":154.4,
    "dividend":0.02,
    "treasuryrate":0.0565
  },
  "1995": {
    "sp500":465.25,
    "cpi":150.3,
    "dividend":0.0224,
    "treasuryrate":0.0778
  },
  "1994": {
    "sp500":472.99,
    "cpi":146.2,
    "dividend":0.0289,
    "treasuryrate":0.0575
  },
  "1993": {
    "sp500":435.23,
    "cpi":142.6,
    "dividend":0.027,
    "treasuryrate":0.066
  },
  "1992": {
    "sp500":416.08,
    "cpi":138.1,
    "dividend":0.0284,
    "treasuryrate":0.0703
  },
  "1991": {
    "sp500":325.49,
    "cpi":134.6,
    "dividend":0.0314,
    "treasuryrate":0.0809
  },
  "1990": {
    "sp500":339.97,
    "cpi":127.4,
    "dividend":0.0368,
    "treasuryrate":0.0821
  },
  "1989": {
    "sp500":285.4,
    "cpi":121.1,
    "dividend":0.0317,
    "treasuryrate":0.0909
  },
  "1988": {
    "sp500":250.5,
    "cpi":115.7,
    "dividend":0.0353,
    "treasuryrate":0.0867
  },
  "1987": {
    "sp500":264.5,
    "cpi":111.2,
    "dividend":0.0366,
    "treasuryrate":0.0708
  },
  "1986": {
    "sp500":208.2,
    "cpi":109.6,
    "dividend":0.0333,
    "treasuryrate":0.0919
  },
  "1985": {
    "sp500":171.6,
    "cpi":105.5,
    "dividend":0.0381,
    "treasuryrate":0.1138
  },
  "1984": {
    "sp500":166.4,
    "cpi":101.9,
    "dividend":0.0458,
    "treasuryrate":0.1167
  },
  "1983": {
    "sp500":144.3,
    "cpi":97.8,
    "dividend":0.0431,
    "treasuryrate":0.1046
  },
  "1982": {
    "sp500":117.3,
    "cpi":94.3,
    "dividend":0.0493,
    "treasuryrate":0.1459
  },
  "1981": {
    "sp500":133,
    "cpi":87,
    "dividend":0.0536,
    "treasuryrate":0.1257
  },
  "1980": {
    "sp500":110.9,
    "cpi":77.8,
    "dividend":0.0461,
    "treasuryrate":0.108
  },
  "1979": {
    "sp500":99.71,
    "cpi":68.3,
    "dividend":0.0524,
    "treasuryrate":0.091
  },
  "1978": {
    "sp500":90.25,
    "cpi":62.5,
    "dividend":0.0528,
    "treasuryrate":0.0796
  },
  "1977": {
    "sp500":103.8,
    "cpi":58.5,
    "dividend":0.0498,
    "treasuryrate":0.0721
  },
  "1976": {
    "sp500":96.86,
    "cpi":55.6,
    "dividend":0.0387,
    "treasuryrate":0.0774
  },
  "1975": {
    "sp500":72.56,
    "cpi":52.1,
    "dividend":0.0415,
    "treasuryrate":0.075
  },
  "1974": {
    "sp500":96.11,
    "cpi":46.6,
    "dividend":0.0537,
    "treasuryrate":0.0699
  },
  "1973": {
    "sp500":118.4,
    "cpi":42.6,
    "dividend":0.0357,
    "treasuryrate":0.0646
  },
  "1972": {
    "sp500":103.3,
    "cpi":41.1,
    "dividend":0.0268,
    "treasuryrate":0.0595
  },
  "1971": {
    "sp500":93.49,
    "cpi":39.8,
    "dividend":0.031,
    "treasuryrate":0.0624
  },
  "1970": {
    "sp500":90.31,
    "cpi":37.8,
    "dividend":0.0349,
    "treasuryrate":0.0779
  },
  "1969": {
    "sp500":102,
    "cpi":35.6,
    "dividend":0.0347,
    "treasuryrate":0.0604
  },
  "1968": {
    "sp500":95.04,
    "cpi":34.1,
    "dividend":0.0288,
    "treasuryrate":0.0553
  },
  "1967": {
    "sp500":84.45,
    "cpi":32.9,
    "dividend":0.0306,
    "treasuryrate":0.0458
  },
  "1966": {
    "sp500":93.32,
    "cpi":31.8,
    "dividend":0.0353,
    "treasuryrate":0.0461
  },
  "1965": {
    "sp500":86.12,
    "cpi":31.2,
    "dividend":0.0297,
    "treasuryrate":0.0419
  },
  "1964": {
    "sp500":76.45,
    "cpi":30.9,
    "dividend":0.0298,
    "treasuryrate":0.0417
  },
  "1963": {
    "sp500":65.06,
    "cpi":30.4,
    "dividend":0.0307,
    "treasuryrate":0.0383
  },
  "1962": {
    "sp500":69.07,
    "cpi":30,
    "dividend":0.034,
    "treasuryrate":0.0408
  },
  "1961": {
    "sp500":59.72,
    "cpi":29.8,
    "dividend":0.0282,
    "treasuryrate":0.0384
  },
  "1960": {
    "sp500":58.03,
    "cpi":29.3,
    "dividend":0.0343,
    "treasuryrate":0.0472
  },
  "1959": {
    "sp500":55.62,
    "cpi":29,
    "dividend":0.031,
    "treasuryrate":0.0402
  },
  "1958": {
    "sp500":41.12,
    "cpi":28.6,
    "dividend":0.0327,
    "treasuryrate":0.0309
  },
  "1957": {
    "sp500":45.43,
    "cpi":27.6,
    "dividend":0.0444,
    "treasuryrate":0.0346
  },
  "1956": {
    "sp500":44.15,
    "cpi":26.8,
    "dividend":0.0375,
    "treasuryrate":0.029
  },
  "1955": {
    "sp500":35.6,
    "cpi":26.7,
    "dividend":0.0361,
    "treasuryrate":0.0261
  },
  "1954": {
    "sp500":25.46,
    "cpi":26.9,
    "dividend":0.044,
    "treasuryrate":0.0248
  },
  "1953": {
    "sp500":26.18,
    "cpi":26.6,
    "dividend":0.0584,
    "treasuryrate":0.0283
  },
  "1952": {
    "sp500":24.19,
    "cpi":26.5,
    "dividend":0.0541,
    "treasuryrate":0.0268
  },
  "1951": {
    "sp500":21.21,
    "cpi":25.4,
    "dividend":0.0602,
    "treasuryrate":0.0257
  },
  "1950": {
    "sp500":16.88,
    "cpi":23.5,
    "dividend":0.0744,
    "treasuryrate":0.0232
  },
  "1949": {
    "sp500":15.36,
    "cpi":24,
    "dividend":0.0689,
    "treasuryrate":0.0231
  },
  "1948": {
    "sp500":14.83,
    "cpi":23.7,
    "dividend":0.0612,
    "treasuryrate":0.0244
  },
  "1947": {
    "sp500":15.21,
    "cpi":21.5,
    "dividend":0.0559,
    "treasuryrate":0.0225
  },
  "1946": {
    "sp500":18.02,
    "cpi":18.2,
    "dividend":0.0469,
    "treasuryrate":0.0219
  },
  "1945": {
    "sp500":13.49,
    "cpi":17.8,
    "dividend":0.0381,
    "treasuryrate":0.0237
  },
  "1944": {
    "sp500":11.85,
    "cpi":17.4,
    "dividend":0.0489,
    "treasuryrate":0.0248
  },
  "1943": {
    "sp500":10.09,
    "cpi":16.9,
    "dividend":0.0531,
    "treasuryrate":0.0247
  },
  "1942": {
    "sp500":8.93,
    "cpi":15.7,
    "dividend":0.062,
    "treasuryrate":0.0246
  },
  "1941": {
    "sp500":10.55,
    "cpi":14.1,
    "dividend":0.0811,
    "treasuryrate":0.0195
  },
  "1940": {
    "sp500":12.3,
    "cpi":13.9,
    "dividend":0.0636,
    "treasuryrate":0.0221
  },
  "1939": {
    "sp500":12.5,
    "cpi":14,
    "dividend":0.0501,
    "treasuryrate":0.0236
  },
  "1938": {
    "sp500":11.31,
    "cpi":14.2,
    "dividend":0.0402,
    "treasuryrate":0.0256
  },
  "1937": {
    "sp500":17.59,
    "cpi":14.1,
    "dividend":0.0726,
    "treasuryrate":0.0268
  },
  "1936": {
    "sp500":13.76,
    "cpi":13.8,
    "dividend":0.0422,
    "treasuryrate":0.0265
  },
  "1935": {
    "sp500":9.26,
    "cpi":13.6,
    "dividend":0.036,
    "treasuryrate":0.0279
  },
  "1934": {
    "sp500":10.54,
    "cpi":13.2,
    "dividend":0.0486,
    "treasuryrate":0.0312
  },
  "1933": {
    "sp500":7.09,
    "cpi":12.9,
    "dividend":0.0441,
    "treasuryrate":0.0331
  },
  "1932": {
    "sp500":8.3,
    "cpi":14.3,
    "dividend":0.0733,
    "treasuryrate":0.0368
  },
  "1931": {
    "sp500":15.98,
    "cpi":15.9,
    "dividend":0.0972,
    "treasuryrate":0.0334
  },
  "1930": {
    "sp500":21.71,
    "cpi":17.1,
    "dividend":0.0632,
    "treasuryrate":0.0329
  },
  "1929": {
    "sp500":24.86,
    "cpi":17.1,
    "dividend":0.0453,
    "treasuryrate":0.036
  },
  "1928": {
    "sp500":17.53,
    "cpi":17.3,
    "dividend":0.0367,
    "treasuryrate":0.0333
  },
  "1927": {
    "sp500":13.4,
    "cpi":17.5,
    "dividend":0.0441,
    "treasuryrate":0.0334
  },
  "1926": {
    "sp500":12.65,
    "cpi":17.9,
    "dividend":0.0511,
    "treasuryrate":0.0368
  },
  "1925": {
    "sp500":10.58,
    "cpi":17.3,
    "dividend":0.0482,
    "treasuryrate":0.0386
  },
  "1924": {
    "sp500":8.83,
    "cpi":17.3,
    "dividend":0.0541,
    "treasuryrate":0.0406
  },
  "1923": {
    "sp500":8.9,
    "cpi":16.8,
    "dividend":0.062,
    "treasuryrate":0.0436
  },
  "1922": {
    "sp500":7.3,
    "cpi":16.9,
    "dividend":0.0581,
    "treasuryrate":0.043
  },
  "1921": {
    "sp500":7.11,
    "cpi":19,
    "dividend":0.0629,
    "treasuryrate":0.0509
  },
  "1920": {
    "sp500":8.83,
    "cpi":19.3,
    "dividend":0.0749,
    "treasuryrate":0.0497
  },
  "1919": {
    "sp500":7.85,
    "cpi":16.5,
    "dividend":0.0594,
    "treasuryrate":0.045
  },
  "1918": {
    "sp500":7.21,
    "cpi":14,
    "dividend":0.0722,
    "treasuryrate":0.0457
  },
  "1917": {
    "sp500":9.57,
    "cpi":11.7,
    "dividend":0.1015,
    "treasuryrate":0.0423
  },
  "1916": {
    "sp500":9.33,
    "cpi":10.4,
    "dividend":0.0571,
    "treasuryrate":0.0405
  },
  "1915": {
    "sp500":7.48,
    "cpi":10.1,
    "dividend":0.0454,
    "treasuryrate":0.0424
  },
  "1914": {
    "sp500":8.37,
    "cpi":10,
    "dividend":0.0571,
    "treasuryrate":0.0416
  },
  "1913": {
    "sp500":9.3,
    "cpi":9.8,
    "dividend":0.0597,
    "treasuryrate":0.0445
  },
  "1912": {
    "sp500":9.12,
    "cpi":9.13,
    "dividend":0.0512,
    "treasuryrate":0.0401
  },
  "1911": {
    "sp500":9.27,
    "cpi":9.23,
    "dividend":0.0516,
    "treasuryrate":0.0398
  },
  "1910": {
    "sp500":10.08,
    "cpi":9.9,
    "dividend":0.0519,
    "treasuryrate":0.0391
  },
  "1909": {
    "sp500":9.06,
    "cpi":8.94,
    "dividend":0.0427,
    "treasuryrate":0.0376
  },
  "1908": {
    "sp500":6.85,
    "cpi":8.66,
    "dividend":0.0443,
    "treasuryrate":0.0387
  },
  "1907": {
    "sp500":9.56,
    "cpi":8.85,
    "dividend":0.067,
    "treasuryrate":0.0367
  },
  "1906": {
    "sp500":9.87,
    "cpi":8.47,
    "dividend":0.0407,
    "treasuryrate":0.0343
  },
  "1905": {
    "sp500":8.43,
    "cpi":8.47,
    "dividend":0.0346,
    "treasuryrate":0.0348
  },
  "1904": {
    "sp500":6.68,
    "cpi":8.28,
    "dividend":0.0376,
    "treasuryrate":0.034
  },
  "1903": {
    "sp500":8.46,
    "cpi":8.66,
    "dividend":0.0533,
    "treasuryrate":0.033
  },
  "1902": {
    "sp500":8.12,
    "cpi":7.9,
    "dividend":0.041,
    "treasuryrate":0.0318
  },
  "1901": {
    "sp500":7.07,
    "cpi":7.71,
    "dividend":0.0403,
    "treasuryrate":0.031
  },
  "1900": {
    "sp500":6.1,
    "cpi":7.9,
    "dividend":0.0437,
    "treasuryrate":0.0315
  },
  "1899": {
    "sp500":6.08,
    "cpi":6.76,
    "dividend":0.0349,
    "treasuryrate":0.031
  },
  "1898": {
    "sp500":4.88,
    "cpi":6.66,
    "dividend":0.0354,
    "treasuryrate":0.0335
  },
  "1897": {
    "sp500":4.22,
    "cpi":6.47,
    "dividend":0.0379,
    "treasuryrate":0.034
  },
  "1896": {
    "sp500":4.27,
    "cpi":6.66,
    "dividend":0.0427,
    "treasuryrate":0.036
  },
  "1895": {
    "sp500":4.25,
    "cpi":6.57,
    "dividend":0.044,
    "treasuryrate":0.0346
  },
  "1894": {
    "sp500":4.32,
    "cpi":6.85,
    "dividend":0.0488,
    "treasuryrate":0.037
  },
  "1893": {
    "sp500":5.61,
    "cpi":7.9,
    "dividend":0.0567,
    "treasuryrate":0.0375
  },
  "1892": {
    "sp500":5.51,
    "cpi":7.33,
    "dividend":0.0436,
    "treasuryrate":0.036
  },
  "1891": {
    "sp500":4.84,
    "cpi":7.8,
    "dividend":0.0407,
    "treasuryrate":0.0362
  },
  "1890": {
    "sp500":5.38,
    "cpi":7.61,
    "dividend":0.0478,
    "treasuryrate":0.0342
  },
  "1889": {
    "sp500":5.24,
    "cpi":7.99,
    "dividend":0.0414,
    "treasuryrate":0.0345
  },
  "1888": {
    "sp500":5.31,
    "cpi":8.37,
    "dividend":0.0447,
    "treasuryrate":0.0367
  },
  "1887": {
    "sp500":5.58,
    "cpi":7.99,
    "dividend":0.0474,
    "treasuryrate":0.0352
  },
  "1886": {
    "sp500":5.2,
    "cpi":7.99,
    "dividend":0.039,
    "treasuryrate":0.0337
  },
  "1885": {
    "sp500":4.24,
    "cpi":8.28,
    "dividend":0.0462,
    "treasuryrate":0.0352
  },
  "1884": {
    "sp500":5.18,
    "cpi":9.23,
    "dividend":0.0714,
    "treasuryrate":0.0362
  },
  "1883": {
    "sp500":5.81,
    "cpi":9.99,
    "dividend":0.0618,
    "treasuryrate":0.0363
  },
  "1882": {
    "sp500":5.92,
    "cpi":10.18,
    "dividend":0.0548,
    "treasuryrate":0.0362
  },
  "1881": {
    "sp500":6.19,
    "cpi":9.42,
    "dividend":0.0532,
    "treasuryrate":0.037
  },
  "1880": {
    "sp500":5.11,
    "cpi":9.99,
    "dividend":0.0445,
    "treasuryrate":0.0402
  },
  "1879": {
    "sp500":3.58,
    "cpi":8.28,
    "dividend":0.0407,
    "treasuryrate":0.0422
  },
  "1878": {
    "sp500":3.25,
    "cpi":9.23,
    "dividend":0.0522,
    "treasuryrate":0.0434
  },
  "1877": {
    "sp500":3.55,
    "cpi":10.94,
    "dividend":0.0585,
    "treasuryrate":0.0445
  },
  "1876": {
    "sp500":4.46,
    "cpi":10.85,
    "dividend":0.0838,
    "treasuryrate":0.0459
  },
  "1875": {
    "sp500":4.54,
    "cpi":11.51,
    "dividend":0.0686,
    "treasuryrate":0.0507
  },
  "1874": {
    "sp500":4.66,
    "cpi":12.37,
    "dividend":0.0727,
    "treasuryrate":0.0547
  },
  "1873": {
    "sp500":5.11,
    "cpi":12.94,
    "dividend":0.0747,
    "treasuryrate":0.0558
  },
  "1872": {
    "sp500":4.86,
    "cpi":12.65,
    "dividend":0.0592,
    "treasuryrate":0.0536
  },
  "1871": {
    "sp500":4.44,
    "cpi":12.46,
    "dividend":0.0549,
    "treasuryrate":0.0532
  }
};

},{}],2:[function(require,module,exports){
/**
  @typedef SingleSimReturn
  @type Object
  @property {Array.<Object>} data - Array of objects containing adjustedNet,
  adjustedSharesBalance, and adjustedBondsBalance properties.
*/

/**
  @typedef SimulationReturn
  @type Object
  @property {Number} successRate - Success rate.
  @property {Array.<Array.<Object>>} data - Array of array of objects containing adjustedNet,
  adjustedSharesBalance, and adjustedBondsBalance properties.
*/

//Months are 0 indexed
//inflation is not in percents
var archive = require('./archive.js').data;

/**
  Runs a single simulation line.

  @param {Object} options - Options object which contains the options necessary for simulation.
  @param {Number} options.startingValue - Starting portfolio value. Required.
  @param {Number} options.startingYear - Starting year for the simulation.
  Must be between 1914 and 2015. Required.
  @param {Number} options.durationYears - Duration of the simulation in years. Required.
  @param {Object} options.allocation - Object which contains the allocations for the starting value. All values must add up to 1.
  @param {Number} options.allocation.equities - Ratio of equities.
  @param {Number} options.allocation.bonds - Ratio of bonds. Will default to 1-equities.
  @param {Number} options.fees - Fees on investments per year. Required.
  @param {Array.<Number>|Number} options.spendingModel - Spending model for the simulation. Required.
  If it is a list of yearly spending, it must be an array at least as large as the durationYears property. Each index says how much money is spent per year.
  If it is a number, that will be the spending per year, adjusted with inflation.
  @param {Boolean} options.rebalance - Whether to rebalance allocation annually. Defaults to false.
  @returns {SingleSimReturn} result - Result of the sim.
*/
function singleSim(options){
  if (options.startingValue === undefined){
    throw "No starting value";
  }
  var startingValue = parseFloat(options.startingValue);
  if (options.startingYear === undefined){
    throw "No starting year";
  }
  var startingYear = parseInt(options.startingYear);
  if (startingYear < 1871 || startingYear > 2016) {
    throw "Starting year not in correct range";
  }
  if (options.durationYears === undefined){
    throw "No duration";
  }
  var durationYears = parseInt(options.durationYears);
  if (durationYears + startingYear > 2016) {
    throw "Duration too long for starting year";
  }
  if (options.spendingModel === undefined){
    throw "No spending model";
  }
  var spendingModel = options.spendingModel;
  if (options.fees === undefined){
    throw "No fees";
  }
  var fees = parseFloat(options.fees);
  if (options.allocation === undefined){
    throw "No allocation";
  }
  var allocation = options.allocation;
  if (allocation.equities === undefined){
    throw "No equities";
  }
  if (allocation.bonds === undefined){
    allocation.bonds = 1-allocation.equities;
  }
  if (allocation.bonds + allocation.equities != 1){
    throw "Allocations do not add up to 1";
  }
  var rebalance;
  if (options.rebalance === undefined){
    rebalance = false;
  }
  else{
    rebalance = options.rebalance;
  }

  var result = {};
  result.data = [];
  var nowYear = 2016;
  //starting net worth is in the starting year's dollars
  var startingNetWorth = inflationAdjuster(startingValue, nowYear, startingYear);
  //actual number of shares that the starting value in the
  //starting year would have bought, inflation adjusted
  var shares = (startingNetWorth*allocation.equities)/archive[''+startingYear].sp500;
  //bonds are in the starting year's dollars
  var bonds = startingNetWorth*allocation.bonds;
  for (var year = 0; year < durationYears; year++){
    var currentYearData = archive[''+(year+startingYear)];
    //dividend
    shares *= 1+currentYearData.dividend;
    //bonds
    //annual percentage yield calculation
    var apy = Math.pow(1+(currentYearData.treasuryrate/2), 2)-1;
    bonds *= 1+apy;
    //fees
    shares *= 1-fees;
    bonds *= 1-fees;
    //subtract spending
    //spending is in inflation adjusted dollars
    var spending;
    if (typeof(spendingModel) == 'object'){
      //spending array
      spending = inflationAdjuster(spendingModel[year], nowYear, year+startingYear);
    }
    else{
      //flat spending
      spending = inflationAdjuster(spendingModel, nowYear, year+startingYear);
    }
    //subtract inflation adjusted spending from each asset type equally
    var valueOfShares = shares*currentYearData.sp500;
    var spendingRatioForEquities = valueOfShares/(bonds+valueOfShares);
    shares -= (spending*spendingRatioForEquities)/currentYearData.sp500;
    bonds -= spending*(1-spendingRatioForEquities);
    //net is in sim year dollars
    var net = (shares*currentYearData.sp500)+(bonds);
    //rebalance
    if (rebalance){
      if (spendingRatioForEquities != allocation.equities){
        //it is not balanced according to allocation
        var newValueOfShares = allocation.equities * net;
        shares = newValueOfShares/currentYearData.sp500;
        bonds = allocation.bonds * net;
      }
    }
    //adjusted net is in current year dollars
    var adjustedNet = worthAdjuster(net, year+startingYear, nowYear);
    var runData = {
      adjustedNet: adjustedNet,
      adjustedSharesBalance: worthAdjuster(shares*currentYearData.sp500, year+startingYear, nowYear),
      adjustedBondsBalance: worthAdjuster(bonds, year+startingYear, nowYear),
    };
    result.data.push(runData);
  }
  return result;
}

/**
  Adjusts an amount of money with inflation to show it's worth at an ending year.
  This will almost always return a lesser amount if the end year is greater.

  @param {Number} amount - Amount of money.
  @param {Number} startYear - Year the amount of money is in currently.
  @param {Number} endYear - Year you want to see the worth of the money in.
  @returns {Number} Worth of the money in the end year, in starting year dollars.
*/
function worthAdjuster(amount, startYear, endYear){
  if (!archive[''+startYear]){
    throw "Start year not in archive";
  }
  if (!archive[''+endYear]){
    throw "End year not in archive";
  }
  return (amount/archive[endYear].cpi)*archive[startYear].cpi;
}

/**
  Adjusts an amount of money with inflation to show it's amount at an ending year.
  This will almost always return a greater amount if the end year is greater.

  @param {Number} amount - Amount of money.
  @param {Number} startYear - Year the amount of money is in currently.
  @param {Number} endYear - Year you want to see the inflated amount of the money in.
  @returns {Number} Number of dollars to equal the worth of the money in the
  start year, in end year dollars.
*/
function inflationAdjuster(amount, startYear, endYear){
  if (!archive[''+startYear]){
    throw "Start year not in archive";
  }
  if (!archive[''+endYear]){
    throw "End year not in archive";
  }
  return (amount/archive[startYear].cpi)*archive[endYear].cpi;
}

/**
  Runs the entire simulation with multiple simulation lines starting in different years.

  @param {Object} options - Options object which contains the options necessary for simulation.
  @param {Number} options.startingValue - Starting portfolio value. Required.
  @param {Number} options.durationYears - Duration of the simulation in years. Required.
  @param {Object} options.allocation - Object which contains the allocations for the starting value. All values must add up to 1.
  @param {Number} options.allocation.equities - Ratio of equities.
  @param {Number} options.allocation.bonds - Ratio of bonds. Will default to 1-equities.
  @param {Number} options.fees - Fees on investments per year. Required.
  @param {Array.<Number>|Number} options.spendingModel - Spending model for the simulation. Required.
  If it is a list of yearly spending, it must be an array at least as large as the durationYears property. Each index says how much money is spent per year.
  If it is a number, that will be the spending per year, adjusted with inflation.
  @param {Boolean} options.rebalance - Whether to rebalance allocation annually. Defaults to false.
  @returns {SimulationReturn} result - Result of the sim.
*/
function simulate(options){
  var result = {};
  result.data = [];
  var totalSuccess = 0;
  var totalRuns = 0;
  for (var year = 1871; year < 2016-options.durationYears; year++){
    var singleOptions = {
      startingValue: options.startingValue,
      startingYear: year,
      durationYears: options.durationYears,
      allocation: options.allocation,
      fees: options.fees,
      spendingModel: options.spendingModel,
      rebalance: options.rebalance
    };
    var singleResult = singleSim(singleOptions);
    if (singleResult.data[singleResult.data.length-1].adjustedNet > 1){
      totalSuccess++;
    }
    totalRuns++;
    result.data.push(singleResult.data);
  }
  result.successRate = totalSuccess/totalRuns;
  return result;
}

exports.singleSim = singleSim;
exports.simulate = simulate;

},{"./archive.js":1}],3:[function(require,module,exports){
var trinity = require('./index.js');

$(function(){
  $('#allocation').on('change mousemove', function(){
    $('#allocationValue').text($(this).val());
  });
  $('#run').on('click', function(){
    var durationYears = parseFloat($('#durationYears').val());
    var labels = [];
    for (var x = 0; x < durationYears; x++){
      labels.push(x);
    }
    var options = {
      startingValue: parseFloat($('#startingValue').val()),
      durationYears: durationYears,
      allocation: {
        equities: parseFloat($('#allocation').val())
      },
      fees: $('#fees').val(),
      spendingModel: parseFloat($('#spending').val()),
      rebalance: parseInt($('#rebalance').val())
    };
    var netData = {
      labels: labels,
      datasets: []
    };
    var equityData = {
      labels: labels,
      datasets: []
    };
    var bondData = {
      labels: labels,
      datasets: []
    };
    var result = trinity.simulate(options);
    $('#successRate').text(result.successRate);
    $('#data').show({
      done: function(){
        for (var y = 0; y < result.data.length; y++){
          var runData = result.data[y];
          var color = randomColor();
          var netDataset = {
            label: ''+y,
            data: [],
            strokeColor: color
          };
          var equityDataset = {
            label: ''+y,
            data: [],
            strokeColor: color
          };
          var bondDataset = {
            label: ''+y,
            data: [],
            strokeColor: color
          };
          for (var z = 0; z < runData.length; z++){
            var yearData = runData[z];
            netDataset.data.push(yearData.adjustedNet);
            equityDataset.data.push(yearData.adjustedSharesBalance);
            bondDataset.data.push(yearData.adjustedBondsBalance);
          }
          netData.datasets.push(netDataset);
          equityData.datasets.push(equityDataset);
          bondData.datasets.push(bondDataset);
        }
        var chartOptions = {
          datasetFill: false,
          pointDot: false,
          showTooltips: false
        };
        new Chart(getContextOfId('netChart')).Line(netData, chartOptions);
        new Chart(getContextOfId('equityChart')).Line(equityData, chartOptions);
        new Chart(getContextOfId('bondChart')).Line(bondData, chartOptions);
      }
    });
  });
});

function randomColor(){
  //return random color
  return "rgba("+Math.floor(Math.random()*255)+
    ","+Math.floor(Math.random()*255)+","+Math.floor(Math.random()*255)+
    ",1)";
}

function getContextOfId(id){
  //gets the 2d context of the canvas by this id
  return $('#'+id).get(0).getContext('2d');
}

},{"./index.js":2}]},{},[3]);
